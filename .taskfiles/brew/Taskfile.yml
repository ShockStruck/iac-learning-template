---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  install:
    desc: "Install CLI tools required for IaC learning on macOS"
    cmds:
      - |
        echo "ğŸº Installing CLI tools for Infrastructure as Code learning..."
        echo
        
        # Check if Homebrew is installed
        if ! command -v brew >/dev/null 2>&1; then
          echo "âŒ Homebrew not found. Installing Homebrew first..."
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        else
          echo "âœ… Homebrew found"
        fi
        
        # Core IaC tools
        echo "ğŸ“¦ Installing core IaC tools..."
        brew install --quiet task/tap/go-task    # Task runner
        brew install --quiet age                  # Encryption for SOPS
        brew install --quiet sops                 # Secret management
        brew install --quiet direnv              # Environment management
        brew install --quiet docker              # Container runtime
        brew install --quiet docker-compose      # Multi-container orchestration
        
        # Development tools
        echo "ğŸ› ï¸  Installing development tools..."
        brew install --quiet git                  # Version control
        brew install --quiet jq                   # JSON processor
        brew install --quiet yq                   # YAML processor
        brew install --quiet tree                 # Directory visualization
        
        # Optional but useful tools
        echo "ğŸš€ Installing optional tools..."
        brew install --quiet htop                 # Process monitor
        brew install --quiet curl                 # HTTP client
        brew install --quiet wget                 # File downloader
        
        echo
        echo "âœ… All CLI tools installed successfully!"
        echo
        echo "ğŸ“‹ Installed tools:"
        echo "   â€¢ task      - Task runner for automation"
        echo "   â€¢ age       - Modern encryption tool"
        echo "   â€¢ sops      - Secret management"
        echo "   â€¢ direnv    - Environment variable management"
        echo "   â€¢ docker    - Container runtime"
        echo "   â€¢ docker-compose - Multi-container orchestration"
        echo "   â€¢ git       - Version control"
        echo "   â€¢ jq/yq     - JSON/YAML processors"
        echo "   â€¢ tree      - Directory visualization"
        echo
        echo "ğŸ”„ Next steps:"
        echo "   1. Restart your terminal or run: source ~/.zshrc"
        echo "   2. Start Docker Desktop application"
        echo "   3. Run: task bootstrap"

  check:
    desc: "Check if all required CLI tools are installed"
    cmds:
      - |
        echo "ğŸ” Checking required CLI tools..."
        echo
        
        tools=(
          "task:Task runner"
          "age:Age encryption"
          "sops:SOPS secret management"
          "direnv:Direnv environment management"
          "docker:Docker container runtime"
          "docker-compose:Docker Compose"
          "git:Git version control"
          "jq:JQ JSON processor"
          "yq:YQ YAML processor"
        )
        
        missing_tools=()
        
        for tool_desc in "${tools[@]}"; do
          tool=${tool_desc%%:*}
          desc=${tool_desc#*:}
          
          if command -v "$tool" >/dev/null 2>&1; then
            version=$("$tool" --version 2>&1 | head -1 || echo "(version unknown)")
            echo "âœ… $desc: $version"
          else
            echo "âŒ $desc: not found"
            missing_tools+=("$tool")
          fi
        done
        
        echo
        
        if [ ${#missing_tools[@]} -eq 0 ]; then
          echo "ğŸ‰ All required tools are installed!"
          echo "ğŸš€ Ready to start IaC learning. Run: task bootstrap"
        else
          echo "âš ï¸  Missing tools: ${missing_tools[*]}"
          echo "ğŸ“¦ Install missing tools with: task brew:install"
          exit 1
        fi

  upgrade:
    desc: "Upgrade all installed CLI tools"
    cmds:
      - |
        echo "â¬†ï¸  Upgrading CLI tools..."
        brew update
        brew upgrade
        echo "âœ… All tools upgraded successfully!"

  doctor:
    desc: "Run Homebrew doctor to check for issues"
    cmds:
      - |
        echo "ğŸ‘©â€âš•ï¸ Running Homebrew doctor..."
        brew doctor
        echo "âœ… Homebrew health check complete!"
