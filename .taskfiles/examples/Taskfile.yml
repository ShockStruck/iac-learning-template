---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  list:
    desc: "List available IaC learning examples"
    cmds:
      - |
        echo "ğŸ—ï¸  Infrastructure as Code Learning Examples"
        echo "================================================"
        echo
        echo "ğŸ” Basic Examples:"
        echo "   â€¢ task examples:basic        - Simple web + database stack"
        echo "   â€¢ task examples:secrets      - SOPS secret management demo"
        echo "   â€¢ task examples:monitoring   - Prometheus + Grafana setup"
        echo
        echo "ğŸš€ Intermediate Examples:"
        echo "   â€¢ task examples:scaling      - Horizontal scaling patterns"
        echo "   â€¢ task examples:networking   - Custom networks and service discovery"
        echo "   â€¢ task examples:persistence  - Volume and data management"
        echo
        echo "ğŸ† Advanced Examples:"
        echo "   â€¢ task examples:loadbalancer - Traefik reverse proxy"
        echo "   â€¢ task examples:backup       - Automated backup strategies"
        echo "   â€¢ task examples:security     - Security hardening patterns"
        echo
        echo "ğŸ“Š Available Profiles:"
        echo "   â€¢ Default:    web, database, cache, app, monitoring"
        echo "   â€¢ utilities:  + backup services"
        echo "   â€¢ advanced:   + load balancer, advanced networking"
        echo
        echo "ğŸš€ Quick Start:"
        echo "   1. task bootstrap           # Set up everything"
        echo "   2. task examples:basic      # Start basic stack"
        echo "   3. Open http://localhost:8080"

  basic:
    desc: "Start basic web application stack (web + database + cache)"
    cmds:
      - task: init
      - task: generate
      - |
        echo "ğŸ”„ Starting basic IaC learning stack..."
        echo "ğŸ“Š Services: web (nginx), database (postgres), cache (redis), app (node.js)"
        echo
        COMPOSE_PROFILES="" task compose:up
        echo
        echo "âœ… Basic stack started successfully!"
        echo
        echo "ğŸŒ Access points:"
        echo "   â€¢ Web App:     http://localhost:8080"
        echo "   â€¢ API App:     http://localhost:3000"
        echo "   â€¢ Database:    localhost:5432 (iac_user/[encrypted])"
        echo "   â€¢ Cache:       localhost:6379"
        echo
        echo "ğŸ“‹ Learn more:"
        echo "   â€¢ View logs:   task compose:logs"
        echo "   â€¢ Check status: task compose:ps"
        echo "   â€¢ Stop stack:  task compose:down"

  monitoring:
    desc: "Start full stack with monitoring (Prometheus + Grafana)"
    cmds:
      - task: init
      - task: generate
      - |
        echo "ğŸ“Š Starting monitoring stack..."
        echo "ğŸ” Services: basic stack + prometheus + grafana"
        echo
        COMPOSE_PROFILES="" task compose:up
        echo
        echo "âœ… Monitoring stack started successfully!"
        echo
        echo "ğŸŒ Access points:"
        echo "   â€¢ Web App:      http://localhost:8080"
        echo "   â€¢ API App:      http://localhost:3000"
        echo "   â€¢ Prometheus:   http://localhost:9090"
        echo "   â€¢ Grafana:      http://localhost:3001 (admin/[encrypted])"
        echo
        echo "ğŸ“Š Monitoring features:"
        echo "   â€¢ Application metrics collection"
        echo "   â€¢ Infrastructure health monitoring"
        echo "   â€¢ Custom dashboards and alerts"

  advanced:
    desc: "Start advanced stack with load balancer and all features"
    cmds:
      - task: init
      - task: generate
      - |
        echo "ğŸš€ Starting advanced IaC learning stack..."
        echo "ğŸ† Services: full stack + traefik load balancer"
        echo
        COMPOSE_PROFILES="advanced" task compose:up
        echo
        echo "âœ… Advanced stack started successfully!"
        echo
        echo "ğŸŒ Access points:"
        echo "   â€¢ Load Balancer: http://localhost (Traefik)"
        echo "   â€¢ Traefik UI:    http://localhost:8081"
        echo "   â€¢ Web App:       http://localhost:8080 (direct)"
        echo "   â€¢ Grafana:       http://localhost:3001"
        echo "   â€¢ Prometheus:    http://localhost:9090"
        echo
        echo "ğŸš€ Advanced features:"
        echo "   â€¢ Automatic service discovery"
        echo "   â€¢ Load balancing and routing"
        echo "   â€¢ SSL/TLS termination (configured)"
        echo "   â€¢ Health checks and failover"

  secrets:
    desc: "Demonstrate SOPS secret management"
    cmds:
      - |
        echo "ğŸ” SOPS Secret Management Demo"
        echo "=============================="
        echo
        echo "ğŸ“„ Current secret status:"
        task sops:status
        echo
        echo "ğŸ” Secret substitution patterns:"
        echo "   â€¢ Database password: ${DATABASE_PASSWORD}"
        echo "   â€¢ App secret key:    ${APP_SECRET_KEY}"
        echo "   â€¢ JWT secret:        ${JWT_SECRET}"
        echo
        echo "ğŸ”§ Secret management commands:"
        echo "   â€¢ Edit secrets:     task sops:edit -- secrets/secret.sops.env"
        echo "   â€¢ View secrets:     task sops:decrypt -- secrets/secret.sops.env"
        echo "   â€¢ Encrypt secrets:  task sops:encrypt"
        echo "   â€¢ Check health:     task sops:health"
        echo
        echo "ğŸ“Š Docker Compose integration:"
        echo "   â€¢ Secrets are automatically decrypted and injected"
        echo "   â€¢ Environment variables use ${VARIABLE_NAME} syntax"
        echo "   â€¢ No plain text secrets in docker-compose.yml"

  networking:
    desc: "Explore Docker networking concepts"
    cmds:
      - task: init
      - task: generate
      - |
        echo "ğŸŒ Docker Networking Learning"
        echo "============================"
        echo
        task compose:up
        echo
        echo "ğŸ” Network topology:"
        echo "   â€¢ app-network:        Frontend and backend services"
        echo "   â€¢ monitoring-network: Prometheus and Grafana"
        echo
        echo "ğŸ—º Network inspection commands:"
        echo "   â€¢ List networks:     docker network ls"
        echo "   â€¢ Inspect network:   docker network inspect iac-learning-template_app-network"
        echo "   â€¢ Service discovery: docker exec iac_app nslookup database"
        echo
        echo "ğŸ”— Service communication:"
        echo "   â€¢ App â†’ Database:     database:5432"
        echo "   â€¢ App â†’ Cache:        cache:6379"
        echo "   â€¢ Grafana â†’ Prometheus: prometheus:9090"

  persistence:
    desc: "Explore data persistence and volume management"
    cmds:
      - task: init
      - task: generate
      - |
        echo "ğŸ“ Data Persistence Learning"
        echo "==========================="
        echo
        task compose:up
        echo
        echo "ğŸ–º Volume management:"
        echo "   â€¢ postgres-data:    Database persistence"
        echo "   â€¢ redis-data:       Cache persistence"
        echo "   â€¢ grafana-data:     Dashboard configuration"
        echo "   â€¢ prometheus-data:  Metrics storage"
        echo
        echo "ğŸ” Volume inspection commands:"
        echo "   â€¢ List volumes:     docker volume ls"
        echo "   â€¢ Inspect volume:   docker volume inspect iac-learning-template_postgres-data"
        echo "   â€¢ Volume usage:     docker system df -v"
        echo
        echo "ğŸ”„ Data persistence testing:"
        echo "   1. Add data to the application"
        echo "   2. Stop stack: task compose:down"
        echo "   3. Start stack: task compose:up"
        echo "   4. Verify data persists"

  backup:
    desc: "Demonstrate backup strategies"
    cmds:
      - task: init
      - task: generate
      - |
        echo "ğŸ’¾ Backup Strategy Demo"
        echo "====================="
        echo
        echo "ğŸ”„ Starting stack with backup service..."
        COMPOSE_PROFILES="utilities" task compose:up
        echo
        echo "ğŸ–º Backup commands:"
        echo "   â€¢ Run backup:       docker-compose run backup"
        echo "   â€¢ List backups:     ls -la backups/"
        echo "   â€¢ Restore from backup: [manual process]"
        echo
        echo "ğŸ” Backup security:"
        echo "   â€¢ Encrypted with APP_SECRET_KEY"
        echo "   â€¢ Retention: 7 days (configurable)"
        echo "   â€¢ Automated scheduling via cron"

  scaling:
    desc: "Demonstrate horizontal scaling patterns"
    cmds:
      - task: init
      - task: generate
      - |
        echo "ğŸ“ˆ Horizontal Scaling Demo"
        echo "========================"
        echo
        task compose:up
        echo
        echo "ğŸ”„ Scaling commands:"
        echo "   â€¢ Scale app:        docker-compose up -d --scale app=3"
        echo "   â€¢ Scale web:        docker-compose up -d --scale web=2"
        echo "   â€¢ Check scaling:    task compose:ps"
        echo
        echo "ğŸ“Š Load balancing:"
        echo "   â€¢ Enable advanced profile for Traefik load balancer"
        echo "   â€¢ Automatic service discovery"
        echo "   â€¢ Health check integration"
        echo
        echo "ğŸ”§ Try scaling now:"
        echo "   docker-compose up -d --scale app=2"

  security:
    desc: "Explore security hardening patterns"
    cmds:
      - |
        echo "ğŸ”’ Security Hardening Patterns"
        echo "=============================="
        echo
        echo "ğŸ” Secret management:"
        echo "   â€¢ SOPS encryption for sensitive data"
        echo "   â€¢ Age key-based encryption"
        echo "   â€¢ No plain text secrets in repository"
        echo
        echo "ğŸŒ Network security:"
        echo "   â€¢ Isolated networks (app vs monitoring)"
        echo "   â€¢ Internal service communication"
        echo "   â€¢ Minimal port exposure"
        echo
        echo "ğŸ›¡ï¸  Container security:"
        echo "   â€¢ Non-root user execution"
        echo "   â€¢ Read-only file systems where possible"
        echo "   â€¢ Health checks for availability"
        echo
        echo "ğŸ“‹ Security checklist:"
        echo "   â€¢ Regular image updates"
        echo "   â€¢ Vulnerability scanning"
        echo "   â€¢ Access logging and monitoring"
        echo "   â€¢ Backup encryption"

  generate:
    desc: "Generate example configuration files"
    cmds:
      - mkdir -p examples/{web,app,database,redis,nginx,monitoring/{grafana/provisioning,prometheus},traefik/{dynamic}}
      - |
        # Generate web content
        cat > examples/web/index.html <<- 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>IaC Learning Template</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                h1 { color: #333; border-bottom: 3px solid #007acc; padding-bottom: 10px; }
                .service { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
                .status { color: #28a745; font-weight: bold; }
                a { color: #007acc; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ—ï¸ Infrastructure as Code Learning Template</h1>
                <p>Welcome to your IaC learning environment! This stack demonstrates modern infrastructure patterns.</p>
                
                <div class="service">
                    <h3>ğŸŒ Web Application</h3>
                    <p class="status">âœ… Running</p>
                    <p>Static web content served by Nginx</p>
                </div>
                
                <div class="service">
                    <h3>ğŸš€ Node.js API</h3>
                    <p><a href="http://localhost:3000">http://localhost:3000</a></p>
                    <p>RESTful API with database connectivity</p>
                </div>
                
                <div class="service">
                    <h3>ğŸ“‹ Monitoring</h3>
                    <p><a href="http://localhost:9090">Prometheus</a> | <a href="http://localhost:3001">Grafana</a></p>
                    <p>Metrics collection and visualization</p>
                </div>
                
                <div class="service">
                    <h3>ğŸ” Secret Management</h3>
                    <p>SOPS encryption with Age keys</p>
                    <p>Environment variables injected securely</p>
                </div>
                
                <h2>ğŸš€ Learning Resources</h2>
                <ul>
                    <li><strong>Task automation:</strong> <code>task --list</code></li>
                    <li><strong>Docker commands:</strong> <code>docker-compose ps</code></li>
                    <li><strong>Logs:</strong> <code>task compose:logs</code></li>
                    <li><strong>Examples:</strong> <code>task examples:list</code></li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Generate Node.js app
        cat > examples/app/package.json <<- 'EOF'
        {
          "name": "iac-learning-app",
          "version": "1.0.0",
          "description": "IaC Learning Template API",
          "main": "server.js",
          "scripts": {
            "start": "node server.js",
            "dev": "nodemon server.js"
          },
          "dependencies": {
            "express": "^4.18.2",
            "pg": "^8.8.0",
            "redis": "^4.5.1",
            "cors": "^2.8.5",
            "helmet": "^6.0.1"
          }
        }
        EOF
        
        cat > examples/app/server.js <<- 'EOF'
        const express = require('express');
        const cors = require('cors');
        const helmet = require('helmet');
        
        const app = express();
        const PORT = process.env.PORT || 3000;
        
        // Middleware
        app.use(helmet());
        app.use(cors());
        app.use(express.json());
        
        // Health check endpoint
        app.get('/health', (req, res) => {
          res.json({
            status: 'healthy',
            timestamp: new Date().toISOString(),
            environment: process.env.NODE_ENV || 'development',
            services: {
              database: process.env.DATABASE_URL ? 'configured' : 'not configured',
              cache: process.env.REDIS_URL ? 'configured' : 'not configured'
            }
          });
        });
        
        // API routes
        app.get('/api/info', (req, res) => {
          res.json({
            message: 'IaC Learning Template API',
            version: '1.0.0',
            environment: process.env.NODE_ENV,
            features: [
              'SOPS secret management',
              'Docker Compose orchestration',
              'Multi-tier architecture',
              'Monitoring integration'
            ]
          });
        });
        
        app.get('/api/env', (req, res) => {
          res.json({
            environment: process.env.NODE_ENV,
            hasDatabase: !!process.env.DATABASE_URL,
            hasCache: !!process.env.REDIS_URL,
            hasSecrets: !!process.env.APP_SECRET_KEY
          });
        });
        
        // Start server
        app.listen(PORT, '0.0.0.0', () => {
          console.log(`ğŸš€ API server running on port ${PORT}`);
          console.log(`ğŸ“Š Health check: http://localhost:${PORT}/health`);
        });
        EOF
        
        # Generate database init script
        cat > examples/database/init.sql <<- 'EOF'
        -- IaC Learning Template Database Initialization
        
        -- Create application schema
        CREATE SCHEMA IF NOT EXISTS app;
        
        -- Create users table
        CREATE TABLE IF NOT EXISTS app.users (
            id SERIAL PRIMARY KEY,
            username VARCHAR(50) UNIQUE NOT NULL,
            email VARCHAR(100) UNIQUE NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        -- Create application logs table
        CREATE TABLE IF NOT EXISTS app.logs (
            id SERIAL PRIMARY KEY,
            level VARCHAR(20) NOT NULL,
            message TEXT NOT NULL,
            metadata JSONB,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        -- Insert sample data
        INSERT INTO app.users (username, email) VALUES 
            ('demo_user', 'demo@example.com'),
            ('admin', 'admin@example.com')
        ON CONFLICT (username) DO NOTHING;
        
        -- Insert sample log entries
        INSERT INTO app.logs (level, message, metadata) VALUES 
            ('info', 'Database initialized successfully', '{"component": "database"}'),
            ('info', 'Sample data inserted', '{"component": "init_script"}')
        ON CONFLICT DO NOTHING;
        
        -- Create index for performance
        CREATE INDEX IF NOT EXISTS idx_logs_created_at ON app.logs (created_at);
        CREATE INDEX IF NOT EXISTS idx_logs_level ON app.logs (level);
        
        EOF
        
        echo "âœ… Generated example configuration files"

  clean:
    desc: "Clean up generated example files"
    cmds:
      - rm -rf examples/
      - echo "ğŸ§¹ Cleaned up generated example files"
