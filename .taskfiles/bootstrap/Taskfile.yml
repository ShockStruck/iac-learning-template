---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
# Bootstrap automation for IaC learning environment
version: '3'

tasks:
  # === Complete Bootstrap Process ===
  all:
    desc: "ğŸš€ Complete bootstrap: dependencies + setup + validation"
    cmds:
      - task: deps
      - task: setup
      - task: validate
      - echo "âœ… Bootstrap complete! Run 'task help' for next steps"
      
  # === Dependency Installation ===
  deps:
    desc: "ğŸ“¦ Install all required dependencies"
    cmds:
      - task: check-platform
      - task: install-brew
      - task: install-tools
      - task: install-docker
      - task: install-python
      
  check-platform:
    desc: "ğŸ” Check platform compatibility"
    cmds:
      - |
        echo "ğŸ—ºï¸ Platform Detection:"
        echo "OS: $(uname -s)"
        echo "Architecture: $(uname -m)"
        echo "Kernel: $(uname -r)"
        
        case "$(uname -s)" in
          Darwin)
            echo "âœ… macOS detected - full support"
            ;;
          Linux)
            echo "âœ… Linux detected - full support"
            if command -v apt-get >/dev/null 2>&1; then
              echo "âœ… APT package manager available"
            elif command -v yum >/dev/null 2>&1; then
              echo "âœ… YUM package manager available"
            else
              echo "âš ï¸  No recognized package manager - manual setup may be needed"
            fi
            ;;
          *)
            echo "âš ï¸  Unsupported platform - some features may not work"
            ;;
        esac
        
  install-brew:
    desc: "ğŸº Install Homebrew package manager"
    cmds:
      - |
        if command -v brew >/dev/null 2>&1; then
          echo "âœ… Homebrew already installed: $(brew --version | head -1)"
        else
          echo "ğŸº Installing Homebrew..."
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          
          # Add to PATH for current session
          case "$(uname -s)" in
            Darwin)
              echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
              eval "$(/opt/homebrew/bin/brew shellenv)"
              ;;
            Linux)
              echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
              eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
              ;;
          esac
          
          echo "âœ… Homebrew installed successfully"
        fi
        
  install-tools:
    desc: "ğŸ”§ Install IaC tools via Homebrew"
    cmds:
      - |
        echo "ğŸ”§ Installing IaC tools..."
        
        # Core tools for IaC learning
        TOOLS="
          git
          direnv
          age
          sops
          go-task/tap/go-task
          pre-commit
          jq
          yq
        "
        
        for tool in $TOOLS; do
          if [[ "$tool" == *"/"* ]]; then
            # Handle tap-based tools
            tool_name=$(basename "$tool")
            if command -v "$tool_name" >/dev/null 2>&1; then
              echo "âœ… $tool_name already installed"
            else
              echo "ğŸ“¦ Installing $tool..."
              brew install "$tool" || echo "âš ï¸  Failed to install $tool"
            fi
          else
            if command -v "$tool" >/dev/null 2>&1; then
              echo "âœ… $tool already installed"
            else
              echo "ğŸ“¦ Installing $tool..."
              brew install "$tool" || echo "âš ï¸  Failed to install $tool"
            fi
          fi
        done
        
        echo "âœ… Tool installation complete"
        
  install-docker:
    desc: "ğŸ³ Install and configure Docker"
    cmds:
      - |
        if command -v docker >/dev/null 2>&1; then
          echo "âœ… Docker already installed: $(docker --version)"
          
          # Check if Docker daemon is running
          if docker info >/dev/null 2>&1; then
            echo "âœ… Docker daemon is running"
          else
            echo "âš ï¸  Docker daemon not running"
            case "$(uname -s)" in
              Darwin)
                echo "ğŸ’¡ Start Docker Desktop app"
                ;;
              Linux)
                echo "ğŸ’¡ Starting Docker daemon..."
                sudo systemctl start docker || echo "âš ï¸  Failed to start Docker"
                sudo systemctl enable docker || echo "âš ï¸  Failed to enable Docker"
                ;;
            esac
          fi
        else
          echo "ğŸ³ Installing Docker..."
          case "$(uname -s)" in
            Darwin)
              echo "ğŸ’¡ Please install Docker Desktop from: https://docker.com/products/docker-desktop"
              echo "After installation, start Docker Desktop and run this task again"
              ;;
            Linux)
              # Install Docker Engine on Linux
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              sudo systemctl start docker
              sudo systemctl enable docker
              rm get-docker.sh
              echo "âœ… Docker installed. Please log out and back in for group changes to take effect"
              ;;
          esac
        fi
        
  install-python:
    desc: "ğŸ Install Python dependencies"
    cmds:
      - |
        echo "ğŸ Installing Python dependencies..."
        
        # Check Python 3
        if command -v python3 >/dev/null 2>&1; then
          echo "âœ… Python 3 available: $(python3 --version)"
        else
          echo "ğŸ“¦ Installing Python 3..."
          brew install python3
        fi
        
        # Install pip dependencies for documentation
        pip3 install --user PyYAML requests jinja2 || echo "âš ï¸  Failed to install some Python packages"
        
        echo "âœ… Python setup complete"
        
  # === Environment Setup ===
  setup:
    desc: "ğŸ  Setup development environment"
    cmds:
      - task: create-dirs
      - task: setup-direnv
      - task: setup-git
      - task: init-secrets
      
  create-dirs:
    desc: "ğŸ“ Create project directory structure"
    cmds:
      - |
        echo "ğŸ“ Creating directory structure..."
        
        DIRS="
          .secrets
          secrets
          examples
          docs
          scripts
          .taskfiles/examples
          .taskfiles/validate
          .taskfiles/readme
        "
        
        for dir in $DIRS; do
          mkdir -p "{{.ROOT_DIR}}/$dir"
          echo "âœ… Created: $dir"
        done
        
  setup-direnv:
    desc: "ğŸŒ Setup direnv environment management"
    cmds:
      - |
        echo "ğŸŒ Setting up direnv..."
        
        # Create .envrc if it doesn't exist
        if [[ ! -f "{{.ROOT_DIR}}/.envrc" ]]; then
          cat > "{{.ROOT_DIR}}/.envrc" << 'EOF'
        # shellcheck disable=SC2148,SC2155
        # IaC Learning Template - Environment Configuration
        
        # SOPS Age encryption key
        export SOPS_AGE_KEY_FILE={{.ROOT_DIR}}/.secrets/age.key
        
        # Task configuration
        export TASK_X_ENV_PRECEDENCE=1
        export TASK_X_MAP_VARIABLES=0
        
        # Project settings
        export IAC_PROJECT_NAME="iac-learning-template"
        export IAC_ENV="development"
        
        # Docker Compose settings
        export COMPOSE_PROJECT_NAME="iac-learning"
        export COMPOSE_FILE="{{.ROOT_DIR}}/examples/docker-compose.yml"
        
        echo "ğŸŒ Environment loaded for IaC Learning Template"
        EOF
          
          echo "âœ… Created .envrc"
        fi
        
        # Allow direnv
        if command -v direnv >/dev/null 2>&1; then
          direnv allow || echo "âš ï¸  Failed to allow direnv"
          echo "âœ… direnv configured"
        else
          echo "âš ï¸  direnv not found - skipping"
        fi
        
  setup-git:
    desc: "ğŸ¤ Setup Git configuration and hooks"
    cmds:
      - |
        echo "ğŸ¤ Setting up Git..."
        
        # Initialize git if not already done
        if [[ ! -d "{{.ROOT_DIR}}/.git" ]]; then
          git init
          echo "âœ… Git repository initialized"
        fi
        
        # Setup pre-commit if available
        if command -v pre-commit >/dev/null 2>&1; then
          echo "ğŸ”— Installing pre-commit hooks..."
          pre-commit install || echo "âš ï¸  Failed to install pre-commit hooks"
        fi
        
  init-secrets:
    desc: "ğŸ” Initialize secrets management"
    cmds:
      - |
        echo "ğŸ” Initializing secrets management..."
        if command -v task >/dev/null 2>&1; then
          task sops:init || echo "âš ï¸  Failed to initialize SOPS"
        else
          echo "âš ï¸  Task not available - skipping SOPS initialization"
        fi
        
  # === Development Environment ===
  dev:
    desc: "ğŸ› ï¸ Setup development environment with additional tools"
    cmds:
      - task: all
      - task: dev-tools
      - task: dev-config
      
  dev-tools:
    desc: "ğŸ› ï¸ Install additional development tools"
    cmds:
      - |
        echo "ğŸ› ï¸ Installing development tools..."
        
        DEV_TOOLS="
          htop
          tree
          watch
          curl
          wget
          httpie
          yamllint
          shellcheck
        "
        
        for tool in $DEV_TOOLS; do
          if command -v "$tool" >/dev/null 2>&1; then
            echo "âœ… $tool already installed"
          else
            echo "ğŸ“¦ Installing $tool..."
            brew install "$tool" || echo "âš ï¸  Failed to install $tool"
          fi
        done
        
  dev-config:
    desc: "âš™ï¸ Setup development configuration"
    cmds:
      - |
        echo "âš™ï¸ Setting up development configuration..."
        
        # Create development-specific environment
        cat > "{{.ROOT_DIR}}/.envrc.dev" << 'EOF'
        # Development-specific environment variables
        export IAC_ENV="development"
        export DEBUG=true
        export VERBOSE=true
        export COMPOSE_PROFILES="monitoring,development"
        EOF
        
        echo "âœ… Development configuration complete"
        
  # === Validation ===
  validate:
    desc: "âœ… Validate bootstrap installation"
    cmds:
      - |
        echo "=== Bootstrap Validation ==="
        failed=0
        
        # Check required commands
        REQUIRED="brew git direnv age sops task docker"
        
        for cmd in $REQUIRED; do
          if command -v "$cmd" >/dev/null 2>&1; then
            echo "âœ… $cmd: $(which $cmd)"
          else
            echo "âŒ $cmd: not found"
            failed=1
          fi
        done
        
        # Check Docker daemon
        if docker info >/dev/null 2>&1; then
          echo "âœ… Docker daemon: running"
        else
          echo "âŒ Docker daemon: not running"
          failed=1
        fi
        
        # Check directory structure
        DIRS=".secrets secrets examples docs"
        for dir in $DIRS; do
          if [[ -d "{{.ROOT_DIR}}/$dir" ]]; then
            echo "âœ… Directory: $dir"
          else
            echo "âŒ Directory: $dir missing"
            failed=1
          fi
        done
        
        if [[ $failed -eq 0 ]]; then
          echo ""
          echo "ğŸ‰ Bootstrap validation PASSED!"
          echo "ğŸš€ Ready to start learning IaC. Run: task help"
        else
          echo ""
          echo "ğŸš¨ Bootstrap validation FAILED"
          echo "ğŸ’¡ Fix the issues above and run: task bootstrap:validate"
          exit 1
        fi
